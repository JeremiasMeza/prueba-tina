name: Deploy Front + Tina (/admin) via SSH

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # pnpm fiable (evita problemas de packageManager)
      - name: Enable & pin pnpm
        run: |
          corepack enable
          corepack prepare pnpm@9.12.3 --activate
          pnpm --version

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install deps
        run: pnpm install --frozen-lockfile

      # Build TODO: Tina + Astro
      - name: Build (pnpm build)
        env:
          TINA_CLIENT_ID: ${{ secrets.TINA_CLIENT_ID }}
          TINA_TOKEN: ${{ secrets.TINA_TOKEN }}
          TINA_BRANCH: ${{ secrets.TINA_BRANCH || 'main' }}
        run: pnpm build

      - name: Prepare SSH
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_KEY:  ${{ secrets.SSH_KEY }}
        run: |
          set -euo pipefail
          test -n "${SSH_HOST:-}" || { echo "❌ SSH_HOST vacío"; exit 1; }
          test -n "${SSH_PORT:-}" || { echo "❌ SSH_PORT vacío"; exit 1; }
          test -n "${SSH_KEY:-}"  || { echo "❌ SSH_KEY vacío"; exit 1; }

          mkdir -p ~/.ssh
          # Limpia CRLF por si la clave se pegó desde Windows
          printf '%s\n' "$SSH_KEY" | sed 's/\r$//' > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # No hagas fallar el job si keyscan no responde
          ssh-keyscan -p "$SSH_PORT" "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Test SSH
        run: |
          ssh -i ~/.ssh/deploy_key -p "${{ secrets.SSH_PORT }}" \
            -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" "echo 'SSH OK: ' \$(uname -a)"


      - name: Create server dirs
        run: |
          ssh -i ~/.ssh/deploy_key -p "${{ secrets.SSH_PORT }}" \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" \
            "mkdir -p ~/deploy/incoming ~/deploy/releases"

      - name: Tar dist and admin
        run: |
          test -d dist || { echo "❌ No existe dist/. Revisa el build"; exit 1; }
          TS="$(date -u +%Y%m%d%H%M%S)"; echo "TS=$TS" >> $GITHUB_ENV
          tar -czf "front-${TS}.tar.gz" -C dist .
          if [ -d admin ]; then
            echo "HAVE_ADMIN=1" >> $GITHUB_ENV
            tar -czf "admin-${TS}.tar.gz" -C admin .
          else
            echo "HAVE_ADMIN=0" >> $GITHUB_ENV
          fi

      - name: Upload tars
        run: |
          scp -i ~/.ssh/deploy_key -P "${{ secrets.SSH_PORT }}" "front-${TS}.tar.gz" \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/deploy/incoming/"
          if [ "${{ env.HAVE_ADMIN }}" = "1" ]; then
            scp -i ~/.ssh/deploy_key -P "${{ secrets.SSH_PORT }}" "admin-${TS}.tar.gz" \
              "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/deploy/incoming/"
          fi

      - name: Deploy to DOCROOT
        run: |
          ssh -i ~/.ssh/deploy_key -p "${{ secrets.SSH_PORT }}" \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" bash -lc "
              set -euo pipefail
              DOCROOT='${{ secrets.SSH_DOCROOT }}'
              TS='${{ env.TS }}'
              mkdir -p ~/deploy/releases/\$TS/front ~/deploy/releases/\$TS/admin

              tar -xzf ~/deploy/incoming/front-\$TS.tar.gz -C ~/deploy/releases/\$TS/front
              rsync -az --delete ~/deploy/releases/\$TS/front/ \"\$DOCROOT\"/

              if [ -f ~/deploy/incoming/admin-\$TS.tar.gz ]; then
                tar -xzf ~/deploy/incoming/admin-\$TS.tar.gz -C ~/deploy/releases/\$TS/admin
                mkdir -p \"\$DOCROOT\"/admin
                rsync -az --delete ~/deploy/releases/\$TS/admin/ \"\$DOCROOT\"/admin/
              fi

              HT=\"\$DOCROOT/.htaccess\"
              touch \"\$HT\"
              grep -q \"Options -Indexes\" \"\$HT\" || echo \"Options -Indexes\" >> \"\$HT\"
              grep -q \"DirectoryIndex\" \"\$HT\" || echo \"DirectoryIndex index.html index.php\" >> \"\$HT\"
            "
